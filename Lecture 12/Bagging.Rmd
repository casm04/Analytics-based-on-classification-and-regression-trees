---
title: "Ensemble learning: Bagging"
author: "Lazaro Alonso"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Bagging (regression)
stands for bootstrap aggregating. It consists of building multiple different decisin tree models from a single training data set by repeatedly using multiple bootstraped subsets of the data and averaging the models. Here, each tree is build independently to the others. 

## Example: 

```{r}
# https://cran.r-project.org/web/packages/modeldata/modeldata.pdf
library(tidymodels)
library(modeldata)
library(ggplot2)
library(baguette)
```

Biomas Data

Ghugare et al (2014) contains a data set where different biomass fuels are characterized by the amount of certain molecules (carbon, hydrogen, oxygen, nitrogen, and sulfur) and the corresponding higher heating value (HHV)

```{r}
data(biomass, package = "modeldata")
glimpse(biomass)
```
```{r}
?biomass
```

### Cleaning...
##### Training... 

```{r}
biomass_tr <-
  biomass %>%
  filter(dataset == "Training") %>%
  dplyr::select(-dataset, -sample)
biomass_tr
```
##### Testing...

```{r}
biomass_te <-
  biomass %>%
  filter(dataset == "Testing") %>%
  dplyr::select(-dataset, -sample)
```


Code... 
https://baguette.tidymodels.org/reference/bagger.html

```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(HHV ~ ., data = biomass_tr, base_model = "MARS", times = 5,
                   control = ctrl)
mars_bag
```
Calculation of variable importance

```{r}
var_imp(mars_bag)
```
```{r}
pred  = predict(mars_bag, new_data = biomass_te)
pred
```

Some plots are missing... do them. What are these values telling us? 
```{r}
mars_bag
```

# regression compare Testig vs Predicted value
```{r}
biomass_te$pred = pred$.pred
g <- ggplot(biomass_te, aes(x = HHV, y = pred)) +
  geom_point() +  geom_line(aes(x = HHV, y = HHV))
g
```

```{r}
ggplot(biomass_te, aes(x = carbon, y = pred)) +
  geom_point() + geom_line(aes(x = carbon, y = HHV))
```


```{r}
g + geom_histogram(aes(fill=class),
                   bins=10,
                   col="black", size = 0.1) +   # change number of bins
  labs(title="Histogram with Fixed Bins",
       subtitle="Engine Displacement across Vehicle Classes")
```

#############################################################################
## Acitivity. Design your own project model (data and bagging model). 
1. Regression (easy, like the one above)
2. Classification (research, read the documentation). 
#############################################################################

1. Regression (easy, like the one above)

### Cleaning...
##### Training... 

```{r}
biomass_tr <-
  biomass %>%
  filter(dataset == "Training") %>%
  select(-dataset, -sample)
biomass_tr
```
##### Testing...

```{r}
biomass_te <-
  biomass %>%
  filter(dataset == "Testing") %>%
  select(-dataset, -sample)
```

```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
mars_bag <- bagger(hydrogen ~ ., data = biomass_tr, base_model = "MARS", times = 5,
                   control = ctrl)
mars_bag
```

generate the predicted value
```{r}
pred  = predict(mars_bag, new_data = biomass_te)
pred
```
# regression compare Testig vs Predicted value
```{r}
biomass_te$pred = pred$.pred
g <- ggplot(biomass_te, aes(x = hydrogen, y = pred)) +
  geom_point() +  geom_line(aes(x = hydrogen, y = hydrogen))
g
```


2. Classification (research, read the documentation). 

```{r}
library(datasets)
head(iris)
glimpse(iris)
iris %>% View()
?iris
```


##### Traning...
##### Testing...
```{r}
set.seed(101) # Set Seed so that same sample can be reproduced in future also
# Now Selecting 75% of data as sample from total 'n' rows of the data  
sample <- sample.int(n = nrow(iris), size = floor(.75*nrow(iris)), replace = F)
train <- iris[sample, ]
test  <- iris[-sample, ]

```

Code... 
https://baguette.tidymodels.org/reference/bagger.html

```{r}
#control	
#A list of options generated by control_bag().
ctrl <- control_bag(var_imp = TRUE)

# `times` is low to make the examples run faster
set.seed(7687)
# Using formulas
#  multivariate adaptive regression splines (MARS)
iris_bag <- bagger(Species ~ ., data = train, base_model = "C5.0", times = 5,
                   control = ctrl)
iris_bag
```

generate the predicted value
```{r}
pred  = predict(iris_bag, new_data = test)
pred
```


```{r}
library(caret)
confusionMatrix(pred$.pred_class,test$Species)
```

